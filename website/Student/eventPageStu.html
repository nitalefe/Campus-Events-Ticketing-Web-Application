<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Event Page</title>
  <link rel="icon" type="image/png" href="../../assets/images/evently_logo_DT.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../css/User/eventPageStu.css">
  <link rel="stylesheet" href="../../css/Shared/toolbar.css">
</head>

<body>
  <!-- Toolbar -->
  <div class="toolbar">
    <img src="../../assets/images/evently_logo_DT.png" alt="Evently Logo" class="toolbar-logo"
      onclick="location.href='../Student/student-dashboard.html'">

    <button class="toolbar-btn" onclick="location.href='../Student/student-dashboard.html'">Home</button>
    <button class="toolbar-btn" onclick="location.href='../Student/myTickets.html'">My Tickets</button>
    <div class="toolbar-spacer"></div>
    <!--to be added with 4th feature-->
    <button class="toolbar-btn" onclick="location.href='../Registration/website.html'">Profile</button>
    <div id="authBtnContainer">
      <button id="logout-btn" class="auth-btn">Log Out</button>
    </div>
  </div>

  <div class="container">
    <img id="eventBanner" src="https://via.placeholder.com/900x340" class="event-image" alt="Event Banner">
    <h1 class="event-title">Loading...</h1>
    <div class="event-date-location"></div>
    <div class="event-description">Loading event details...</div>

    <div class="student-actions">
      <!-- <button id="buyBtn" class="buy-ticket-btn">Buy Ticket</button> -->
      <button id="buyBtn" class="buy-ticket-btn"
      onclick="location.href='claimEvent.html?id=' + new URLSearchParams(window.location.search).get('id')">
      Buy Ticket
    </button>




      <button id="saveBtn" class="save-btn">Save Event</button>
      <button id="calendarBtn" class="save-btn">Add to Calendar</button>
      <button id="contactBtn" class="save-btn">Contact Organizer</button>

            <button id="viewTicketBtn" class="save-btn"
    onclick="location.href='qrGenerator.html?id=' + new URLSearchParams(window.location.search).get('id')">
    View Ticket
  </button>


    </div>
  </div>

  <!-- Firebase scripts -->
  <script type="module">
    import { auth, db } from "../../js/Shared/firebase-config.js";
    import { doc, getDoc, updateDoc, setDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

    const params = new URLSearchParams(window.location.search);
    const eventId = params.get("id");

    const viewTicketBtn = document.getElementById("viewTicketBtn");



    const titleEl = document.querySelector(".event-title");
    const descEl = document.querySelector(".event-description");
    const dateLocEl = document.querySelector(".event-date-location");
  const bannerEl = document.getElementById("eventBanner");
  const saveBtn = document.getElementById("saveBtn");
  const contactBtn = document.getElementById("contactBtn");

  // keep the loaded event data available for handlers
  let loadedEventData = null;

    // --------------------------------------------------
    // 1Ô∏è‚É£ Load event details
    // --------------------------------------------------
    async function loadEventDetails(user) {
      if (!eventId) {
        titleEl.textContent = "Event not found.";
        return;
      }

      const docRef = doc(db, "events", eventId);
      const snap = await getDoc(docRef);

      if (!snap.exists()) {
        titleEl.textContent = "Event not found.";
        descEl.textContent = "";
        return;
      }

  const data = snap.data();
  // cache loaded data for handlers (contact lookup, etc.)
  loadedEventData = data;
      titleEl.textContent = data.eventName || "Untitled Event";
      descEl.innerHTML = data.eventDescription || "No description available.";

      const dateObj = data.eventDateTime?.toDate?.();
      const dateStr = dateObj ? dateObj.toDateString() : "Unknown date";
      dateLocEl.innerHTML = `<span>${dateStr}</span><br><span>${data.eventLocation || "Unknown location"}</span>`;

      // Load event banner
      if (data.banner) {
        bannerEl.src = data.banner;
        bannerEl.alt = `${data.eventName} Banner`;
      } else {
        bannerEl.src = "https://via.placeholder.com/900x340";
        bannerEl.alt = "Event Banner";
      }
    }

    // ----------------------------
    // Contact Organizer ‚Äî show popup with creator email
    // ----------------------------
    async function showOrganizerContactForLoadedEvent() {
      if (!loadedEventData) {
        alert('Event data not loaded yet.');
        return;
      }

      // Prefer an explicit organizer email on the event doc if present
      let email = loadedEventData.organizerEmail || loadedEventData.organizer_email || '';

      // Otherwise, try to resolve createdBy -> users/{uid}.email
      if (!email && loadedEventData.createdBy) {
        try {
          const userRef = doc(db, 'users', loadedEventData.createdBy);
          const userSnap = await getDoc(userRef);
          if (userSnap.exists()) {
            const ud = userSnap.data();
            email = ud.email || '';
          }
        } catch (err) {
          console.error('Error fetching organizer user:', err);
        }
      }

      // Build a small modal if we have an email, else show a friendly message
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.background = 'rgba(0,0,0,0.45)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = 9999;

      const modal = document.createElement('div');
      modal.style.background = '#fff';
      modal.style.padding = '16px 18px';
      modal.style.borderRadius = '10px';
      modal.style.maxWidth = '420px';
      modal.style.width = 'min(92%,420px)';
      modal.style.boxShadow = '0 8px 30px rgba(0,0,0,0.25)';
      modal.style.color = '#0b254a';
      modal.style.fontFamily = 'inherit';

      const h = document.createElement('h3');
      h.textContent = 'Contact Organizer';
      h.style.margin = '0 0 8px 0';
      h.style.fontSize = '1.05rem';
      modal.appendChild(h);

      if (email) {
        const p = document.createElement('p');
        p.textContent = 'Organizer email:';
        p.style.margin = '0 0 6px 0';
        p.style.fontWeight = '600';
        modal.appendChild(p);

        const link = document.createElement('a');
        link.href = `mailto:${email}`;
        link.textContent = email;
        link.style.color = '#1a56db';
        link.style.fontWeight = '600';
        link.style.wordBreak = 'break-all';
        modal.appendChild(link);
      } else {
        const p = document.createElement('p');
        p.textContent = "Organizer's contact information is not available.";
        p.style.margin = '0';
        modal.appendChild(p);
      }

      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.justifyContent = 'flex-end';
      actions.style.gap = '8px';
      actions.style.marginTop = '14px';

      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'Close';
      closeBtn.style.padding = '8px 12px';
      closeBtn.style.border = 'none';
      closeBtn.style.borderRadius = '8px';
      closeBtn.style.background = 'linear-gradient(90deg,#e0e6ff,#cfe0ff)';
      closeBtn.style.cursor = 'pointer';
      closeBtn.onclick = () => document.body.removeChild(overlay);

      actions.appendChild(closeBtn);
      modal.appendChild(actions);

      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      // allow closing by clicking outside
      overlay.addEventListener('click', (ev) => { if (ev.target === overlay) document.body.removeChild(overlay); });
    }

    // ----------------------------
    // Save / Unsave Event (Students only)
    // ----------------------------
    async function toggleSaveEvent(user) {
      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);

      if (!userSnap.exists()) {
        await setDoc(userRef, { savedEvents: [] });
      }

      const data = userSnap.data() || {};
      const saved = data.savedEvents || [];

      if (saved.includes(eventId)) {
        await updateDoc(userRef, { savedEvents: arrayRemove(eventId) });
        saveBtn.textContent = "Save Event";
        saveBtn.style.background = "linear-gradient(90deg, #0078d4 60%, #367bfc 100%)";
        alert("Event removed from your saved list.");
      } else {
        await updateDoc(userRef, { savedEvents: arrayUnion(eventId) });
        saveBtn.textContent = "Unsave Event";
        saveBtn.style.background = "linear-gradient(90deg, #e74c3c 60%, #c0392b 100%)"; // üî¥ red
        alert("Event saved successfully!");
      }
    }


    // ----------------------------
    // üîπ Auth State Listener
    // ----------------------------
    onAuthStateChanged(auth, async (user) => {
      console.log("[eventPage] Auth user:", user?.uid || "No user");
      await loadEventDetails(user);

      //add view ticket logic here
      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);
      const params = new URLSearchParams(window.location.search);
      const eventId = params.get("id");
      if (Object.values(userSnap.data().claimedEvents || {}).includes(eventId)) {
        viewTicketBtn.style.display = "inline-block";
        viewTicketBtn.onclick = () =>
          location.href = `qrGenerator.html?id=${eventId}`;
      } else {
        viewTicketBtn.style.display = "none";
      }

      if (!saveBtn) return;
      saveBtn.style.display = "none";

      if (user) {
        // Fetch role
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        const userData = userSnap.data();
        const role = userData?.role || "student";

        // üö´ Hide save button for organizers
        if (role === "organizer") {
          saveBtn.style.display = "none";
          return;
        }

        // ‚úÖ Show for students
        saveBtn.style.display = "inline-block";

        const saved = userData?.savedEvents || [];
        if (saved.includes(eventId)) {
          saveBtn.textContent = "Unsave Event";
          saveBtn.style.background = "linear-gradient(90deg, #e74c3c 60%, #c0392b 100%)";
          saveBtn.style.color = "#fff"; // ‚úÖ make "Save Event" text white
        } else {
          saveBtn.textContent = "Save Event";
          saveBtn.style.background = "linear-gradient(90deg, #0078d4 60%, #367bfc 100%)";
          saveBtn.style.color = "#fff"; // ‚úÖ make "Save Event" text white
        }

        // üëá toggleSaveEvent now works
        saveBtn.onclick = () => toggleSaveEvent(user);
      }
    });

<<<<<<< HEAD
    // wire contact button outside auth flow so any visitor can click
    if (contactBtn) {
      contactBtn.addEventListener('click', (e) => {
        e.preventDefault();
        showOrganizerContactForLoadedEvent();
      });
    }

    // ----------------------------
    // Add to Calendar
    // ----------------------------
    const calendarBtn = document.getElementById('calendarBtn');
    function toICalDate(d) {
      // Return YYYYMMDDTHHMMSSZ (UTC)
      const iso = new Date(d).toISOString();
      return iso.replace(/[-:]/g, '').split('.')[0] + 'Z';
    }
    function escapeICal(text) {
      if (!text) return '';
      return String(text).replace(/\\r\\n|\\r|\\n/g, '\\n').replace(/,/g, '\\,');
    }

    if (calendarBtn) {
      calendarBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (!loadedEventData) {
          alert('Event data not loaded yet.');
          return;
        }

        // derive start/end
        const start = loadedEventData.eventDateTime && typeof loadedEventData.eventDateTime.toDate === 'function'
          ? loadedEventData.eventDateTime.toDate()
          : (loadedEventData.eventDateTime ? new Date(loadedEventData.eventDateTime) : new Date());
        const end = new Date(start.getTime() + (2 * 60 * 60 * 1000)); // default 2 hours

        const title = loadedEventData.eventName || 'Event';
        const description = (loadedEventData.eventDescription || '').replace(/<[^>]*>/g, '');
        const location = loadedEventData.eventLocation || '';
        const uid = `${eventId || Math.random().toString(36).slice(2)}@evently.local`;

        const now = new Date();
        const ics = [
          'BEGIN:VCALENDAR',
          'VERSION:2.0',
          'PRODID:-//Evently//EN',
          'BEGIN:VEVENT',
          `UID:${uid}`,
          `DTSTAMP:${toICalDate(now)}`,
          `DTSTART:${toICalDate(start)}`,
          `DTEND:${toICalDate(end)}`,
          `SUMMARY:${escapeICal(title)}`,
          `DESCRIPTION:${escapeICal(description)}`,
          `LOCATION:${escapeICal(location)}`,
          'END:VEVENT',
          'END:VCALENDAR'
        ].join('\r\n');

        // download .ics
        try {
          const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${(title.replace(/[^a-z0-9]+/gi, '_') || 'event')}.ics`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        } catch (err) {
          console.error('Could not create ICS file', err);
        }

        // open Google Calendar event editor
        const gDates = `${toICalDate(start)}/${toICalDate(end)}`;
        const gUrl = `https://calendar.google.com/calendar/r/eventedit?text=${encodeURIComponent(title)}&dates=${gDates}&details=${encodeURIComponent(description)}&location=${encodeURIComponent(location)}`;
        window.open(gUrl, '_blank');
      });
    }
=======


    
>>>>>>> main
  </script>
</body>

</html>