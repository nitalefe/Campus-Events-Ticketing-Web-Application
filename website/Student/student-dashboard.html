<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="../../assets/images/evently_logo_DT.png" />
  <title>Student Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../../css/Shared/dashboard.css" />
  <link rel="stylesheet" href="../../css/Shared/toolbar.css" />
  <!-- moved filter styles to shared CSS (`css/Shared/dashboard.css`) -->
</head>

<body class="student-page" data-event-page="eventPageStu.html">

  <!-- Toolbar -->
  <div class="toolbar">
    <img src="../../assets/images/evently_logo_DT.png" alt="Evently Logo" class="toolbar-logo"
      onclick="location.href='../Student/student-dashboard.html'">
    <button class="toolbar-btn" onclick="location.href='../Student/student-dashboard.html'">Home</button>
    <button class="toolbar-btn" onclick="location.href='../Student/myTickets.html'">My Tickets</button>
    <div class="toolbar-spacer"></div>
    <button class="toolbar-btn" onclick="location.href='../Registration/website.html'">Profile</button>
    <div id="authBtnContainer">
      <button id="logout-btn" class="auth-btn">Log Out</button>
    </div>
  </div>

  <header>
    <h1>Explore Events</h1>
    <p>Discover events on campus and RSVP quickly.</p>
  </header>

  <!-- Search -->
  <div class="search-bar">
    <input type="text" class="search-input" placeholder="Search events...">
    <button class="search-btn" onclick="handleSearch()">Search</button>
    <button id="clear-search" class="search-btn" style="display:none;margin-left:8px" onclick="clearSearchView()">Clear</button>
  </div>

  <!-- Date Filter -->
  <div class="filter-panel">
    <div class="filter-title">Filter</div>
    <div class="filters-wrap">
      <form id="date-filter" class="date-filter">
      <label>
        <span>From</span>
        <input id="df-from" type="date" />
      </label>
      <label>
        <span>To</span>
        <input id="df-to" type="date" />
      </label>

      <div class="df-presets">
        <button type="button" data-preset="today">Today</button>
        <button type="button" data-preset="week">This week</button>
        <button type="button" data-preset="weekend">This weekend</button>
        <button type="button" id="df-clear">Clear</button>
      </div>

      <label style="display:flex;align-items:center;gap:8px;white-space:nowrap;">
        <span style="color:inherit;font-weight:600">University:</span>
        <select id="filterUniversity" name="filterUniversity">
          <option value="">All universities</option>
          <option value="Concordia">Concordia University</option>
          <option value="McGill">McGill University</option>
          <option value="UdeM">Université de Montréal</option>
          <option value="Polytechnique">Polytechnique Montréal</option>
          <option value="HEC">HEC Montréal</option>
          <option value="UQAM">UQAM</option>
        </select>
      </label>

      <!-- Category filter checkboxes (match eventCreation.html options) -->
      <div class="category-row">
        <span class="category-title">Category:</span>
        <div class="category-controls">
          <label class="cat-option"><input type="checkbox" name="filterCategory" value="Workshop">Workshop</label>
          <label class="cat-option"><input type="checkbox" name="filterCategory" value="Seminar">Seminar</label>
          <label class="cat-option"><input type="checkbox" name="filterCategory" value="Concert">Concert</label>
          <label class="cat-option"><input type="checkbox" name="filterCategory" value="Sports">Sports</label>
          <label class="cat-option"><input type="checkbox" name="filterCategory" value="Other">Other</label>
        </div>
      </div>

      <button type="submit" class="df-apply">Apply</button>
      </form>
    </div>
  </div>

  <!-- Dynamic sections -->
  <div class="main-content">
    <div>
      <div class="section-bar">My Events</div>
      <div class="events-container"><div class="events" id="myEventsSection"></div></div>
    </div>

    <div>
      <div class="section-bar">Saved Events</div>
      <div class="events-container"><div class="events" id="saved-events"></div></div>
    </div>

    <div>
      <div class="section-bar">Upcoming On Campus</div>
      <div class="events-container"><div class="events" id="upcoming-events"></div></div>
    </div>

    <div>
      <div class="section-bar">Discover</div>
      <div class="events-container"><div class="events" id="discover-events"></div></div>
    </div>

    <!-- Search results -->
    <div id="search-results-section" class="is-hidden">
      <div class="section-bar">Search Results</div>
      <div class="events-container"><div class="events" id="search-results"></div></div>
    </div>
  </div>

  <!-- Search + Date filter logic -->
  <script type="module">
    // ---- SEARCH (existing) ----
    function clearSearchView() {
      document.getElementById('search-results-section').classList.add('is-hidden');
      document.getElementById('clear-search').style.display = 'none';
      document.querySelectorAll('.main-content > div').forEach(section => {
        if (section.id !== 'search-results-section') section.classList.remove('is-hidden');
      });
      const sr = document.getElementById('search-results'); while (sr && sr.firstChild) sr.removeChild(sr.firstChild);
    }
    window.handleSearch = function () {
      const query = document.querySelector('.search-input').value.toLowerCase().trim();
      if (!query) { clearSearchView(); return; }

      const matches = []; const seen = new Set();
      document.querySelectorAll('.events').forEach(list => {
        list.querySelectorAll('.event-card').forEach(card => {
          const id = card.getAttribute('data-event-id') || '';
          if (seen.has(id)) return;
          const title = (card.querySelector('.event-title') || { textContent: '' }).textContent.toLowerCase();
          if (title.includes(query)) { matches.push(card); seen.add(id); }
        });
      });

      document.querySelectorAll('.main-content > div').forEach(section => {
        if (section.id !== 'search-results-section') section.classList.add('is-hidden');
      });

      const sr = document.getElementById('search-results'); while (sr && sr.firstChild) sr.removeChild(sr.firstChild);
      matches.forEach(card => {
        const clone = card.cloneNode(true);
        clone.style.display = 'block';
        const id = clone.getAttribute('data-event-id') || card.getAttribute('data-event-id');
        if (id) {
          const target = document.body?.dataset?.eventPage || 'eventPageStu.html';
          clone.addEventListener('click', () => { window.location.href = `${target}?id=${id}`; });
          clone.style.cursor = 'pointer';
        }
        sr.appendChild(clone);
      });

      document.getElementById('search-results-section').classList.remove('is-hidden');
      document.getElementById('clear-search').style.display = '';
    };
    document.getElementById('clear-search').addEventListener('click', clearSearchView);

    // ---- DATE FILTER (client-side, works with current cards) ----
    const form = document.getElementById("date-filter");
    const inputFrom = document.getElementById("df-from");
    const inputTo   = document.getElementById("df-to");
    const btnClear  = document.getElementById("df-clear");
    const presets   = form.querySelectorAll("[data-preset]");

    const startOfDay = (d)=> new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0);
    const endOfDay   = (d)=> new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999);

    function setPresetActive(key) {
      presets.forEach(b => b.classList.toggle('active', b.dataset.preset === key));
    }

    function applyPreset(key) {
      const now = new Date();
      if (key === "today") {
        inputFrom.valueAsDate = now; inputTo.valueAsDate = now;
      } else if (key === "week") {
        const day = now.getDay(); // 0 Sun..6 Sat
        const diffToMon = (day + 6) % 7;
        const monday = new Date(now); monday.setDate(now.getDate() - diffToMon);
        const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
        inputFrom.valueAsDate = monday; inputTo.valueAsDate = sunday;
      } else if (key === "weekend") {
        const day = now.getDay();
        const sat = new Date(now); sat.setDate(sat.getDate() + ((6 - day + 7) % 7));
        const sun = new Date(sat); sun.setDate(sat.getDate() + 1);
        inputFrom.valueAsDate = sat; inputTo.valueAsDate = sun;
      }
      setPresetActive(key);
    }

    presets.forEach(btn => {
      btn.addEventListener("click", () => {
        applyPreset(btn.dataset.preset);
        form.dispatchEvent(new Event("submit"));
      });
    });

    btnClear.addEventListener("click", () => {
      inputFrom.value = ""; inputTo.value = ""; setPresetActive(null);
      filterVisibleByDate(null, null);
    });

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const from = inputFrom.value ? startOfDay(new Date(inputFrom.value)) : null;
      const to   = inputTo.value   ? endOfDay(new Date(inputTo.value))     : null;
      if (from && to && from > to) { // swap if user reversed
        const tmp = from; (from = to), (to = tmp);
        inputFrom.valueAsDate = from; inputTo.valueAsDate = to;
      }
      setPresetActive(null);
      filterVisibleByDate(from, to);
    });

    // University filter select (choose a specific university or All)
    const filterUniversity = document.getElementById('filterUniversity');
    if (filterUniversity) {
      filterUniversity.addEventListener('change', () => {
        const from = inputFrom.value ? startOfDay(new Date(inputFrom.value)) : null;
        const to   = inputTo.value   ? endOfDay(new Date(inputTo.value))     : null;
        filterVisibleByDate(from, to);
      });
    }

    // Category filter checkboxes (workshop, seminar, concert, sports, other)
    const categoryCheckboxes = Array.from(document.querySelectorAll('input[name="filterCategory"]'));
    if (categoryCheckboxes.length) {
      categoryCheckboxes.forEach(cb => cb.addEventListener('change', () => {
        const from = inputFrom.value ? startOfDay(new Date(inputFrom.value)) : null;
        const to   = inputTo.value   ? endOfDay(new Date(inputTo.value))     : null;
        filterVisibleByDate(from, to);
      }));
    }

    // Annotate cards with timestamps and filter
    function parseEventStart(card) {
      // prefer data-start (ms). If absent, try <time datetime>, else parse text
      const ds = card.getAttribute('data-start');
      if (ds) { const n = Number(ds); if (!Number.isNaN(n)) return n; }

      const t = card.querySelector('time[datetime]');
      if (t && t.getAttribute('datetime')) {
        const n = Date.parse(t.getAttribute('datetime')); if (!Number.isNaN(n)) return n;
      }

      // Heuristic: look for a child with class likely holding date text
      const maybe = card.querySelector('.event-date, .date, .text-sm, .meta');
      const text = (maybe?.textContent || card.textContent || '').trim();
      const n = Date.parse(text);
      return Number.isNaN(n) ? null : n;
    }

    // Watches for new cards (rendered by your Firestore loaders)
    const mo = new MutationObserver(entries => {
      entries.forEach(e => {
        e.addedNodes.forEach(n => {
          if (!(n instanceof HTMLElement)) return;
          if (n.classList?.contains('event-card')) {
            if (!n.hasAttribute('data-start')) {
              const ts = parseEventStart(n);
              if (ts) n.setAttribute('data-start', String(ts));
            }
          }
        });
      });
    });
    document.querySelectorAll('.events').forEach(list => {
      mo.observe(list, { childList: true, subtree: true });
    });

    function filterVisibleByDate(from, to) {
      // hide or show cards based on [data-start]
      const lists = document.querySelectorAll('.events');
      const selectedUni = document.getElementById('filterUniversity')?.value || '';
      const selectedCategories = Array.from(document.querySelectorAll('input[name="filterCategory"]:checked')).map(n => n.value.toLowerCase());

      // helper: determines whether a card matches the selected university
      function isUniversityEvent(card, selected) {
        if (!selected) return true; // no filtering
        // prefer explicit data attribute if present (data-open-to="Concordia,McGill")
        const openAttr = card.getAttribute('data-open-to') || card.dataset.openTo;
        if (openAttr) {
          const arr = String(openAttr).split(/[,;]+/).map(s => s.trim().toLowerCase()).filter(Boolean);
          if (arr.includes(selected.toLowerCase())) return true;
        }
        // check event-location or title text for university keyword
        const loc = (card.querySelector('.event-location')?.textContent || '').toLowerCase();
        const title = (card.querySelector('.event-title')?.textContent || '').toLowerCase();
        if (loc.includes(selected.toLowerCase()) || title.includes(selected.toLowerCase())) return true;
        // fallback: generic university keyword match
        const keywords = ['university', 'campus', 'school'];
        return keywords.some(k => loc.includes(k) || title.includes(k));
      }
      lists.forEach(list => {
        list.querySelectorAll('.event-card').forEach(card => {
          let ts = card.getAttribute('data-start');
          if (!ts) { const parsed = parseEventStart(card); if (parsed) { ts = String(parsed); card.setAttribute('data-start', ts); } }
          const n = ts ? Number(ts) : NaN;

          let visible = true;
          if (from && !(n >= +from)) visible = false;
          if (to && !(n <= +to)) visible = false;
          if (selectedUni && !isUniversityEvent(card, selectedUni)) visible = false;
          // category filtering: if any category is selected, the card must match one
          if (selectedCategories.length > 0) {
            const cat = (card.getAttribute('data-category') || card.dataset.category || '').toLowerCase().trim();
            const matches = cat ? selectedCategories.includes(cat) : selectedCategories.some(sc => {
              // fallback: check visible text for the category word
              const title = (card.querySelector('.event-title')?.textContent || '').toLowerCase();
              const loc = (card.querySelector('.event-location')?.textContent || '').toLowerCase();
              return title.includes(sc) || loc.includes(sc);
            });
            if (!matches) visible = false;
          }

          card.style.display = visible ? "" : "none";
        });
        // force chevron visibility recompute (scroll-controls listens to resize/scroll)
        list.dispatchEvent(new Event('scroll'));
      });

      // If Search Results are open, re-run search so it respects the date range
      const srOpen = !document.getElementById('search-results-section')?.classList.contains('is-hidden');
      if (srOpen) window.handleSearch();
    }
  </script>

  <!-- Your existing scripts -->
  <script type="module" src="../../Shared/firebase-config.js"></script>
  <script type="module" src="../../js/Registration/auth.js"></script>
  <script type="module" src="../../js/Events/LoadEvents.js"></script>
  <script type="module" src="../../shared/scroll-controls.js"></script>

</body>
</html>

