<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Event QR</title>
  <link rel="stylesheet" href="../../css/User/qrGenerator.css" />
</head>

<body>
  <div class="wrap">
    <h1>Event QR Code</h1>
    <div class="panel">
      <div id="status"></div>
      <form id="qrForm">
        <div>
          <label for="eid">Event ID</label>
          <input id="eid" name="eid" type="text" placeholder="e.g., evt_123" required />
        </div>
        <div>
          <label for="aid">Attendee ID</label>
          <input id="aid" name="aid" type="text" placeholder="e.g., att_456" required />
        </div>
        <div class="row" style="align-self: start;">
          <label class="row" style="margin:0;">
            <input id="enc" type="checkbox" />
            Encrypt
          </label>
          <button id="genBtn" type="submit">Generate</button>
        </div>
      </form>

      <div id="qrcode" aria-label="QR code will appear here"></div>
      <div class="hint">Use URL params: <code>?eid=evt_123&aid=att_456&enc=1</code></div>
    </div>
  </div>

  <!-- qrcode.js must load BEFORE the module that calls new QRCode(...) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous"
    referrerpolicy="no-referrer"></script>

  <!-- Your generator module in /Script -->

  <script type="module" src="../../js/QRcode/generator.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);
    const setStatus = (msg) => { const n = $("status"); if (n) n.textContent = msg || ""; };

    // Boot from URL params if provided
    (async function bootFromParams() {
      const p = new URLSearchParams(location.search);
      const eid = p.get("eid");
      const aid = p.get("aid");
      const enc = p.get("enc") === "1";

      if (eid) $("eid").value = eid;
      if (aid) $("aid").value = aid;
      if (enc) $("enc").checked = true;

      if (eid && aid && typeof window.setIdsAndRenderQR === "function") {
        setStatus("Generating QR from URL parameters…");
        try {
          await window.setIdsAndRenderQR(eid, aid, { encrypt: enc });
          setStatus("");
        } catch (e) {
          console.error(e);
          setStatus("Failed to generate QR from URL params.");
        }
      }
    })();

    // Form submit → generate QR
    $("qrForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const eid = $("eid").value.trim();
      const aid = $("aid").value.trim();
      const enc = $("enc").checked;

      if (!eid || !aid) {
        setStatus("Please provide both Event ID and Attendee ID.");
        return;
      }

      if (typeof window.setIdsAndRenderQR !== "function") {
        setStatus("QR module not loaded. Check the path: ./Script/generator.js");
        return;
      }

      $("genBtn").disabled = true;
      setStatus("Generating QR…");
      try {
        await window.setIdsAndRenderQR(eid, aid, { encrypt: enc });
        setStatus("");
      } catch (err) {
        console.error(err);
        setStatus("Failed to generate QR. See console.");
      } finally {
        $("genBtn").disabled = false;
      }
    });
  </script>
</body>

</html>