<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Users & Organizations</title>
  <link rel="icon" type="image/png" href="../../assets/images/evently_logo_DT.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../css/Shared/dashboard.css">
  <link rel="stylesheet" href="../../css/Shared/toolbar.css">
  <link rel="stylesheet" href="../../css/Administrator/view-users.css">
</head>

<body class="view-users-page">
  <!-- Shared toolbar (standardized) -->
  <div class="toolbar">
    <img src="../../assets/images/evently_logo_DT.png" alt="Evently Logo" class="toolbar-logo" onclick="location.href='admin-dashboard.html'">

    <button class="toolbar-btn" onclick="location.href='admin-dashboard.html'">Home</button>
    <button class="toolbar-btn" onclick="location.href='AdminAnalytics.html'">Analytics</button>
    <button class="toolbar-btn" onclick="location.href='AdminApproval.html'">Approvals</button>
    <button class="toolbar-btn" onclick="location.href='Adminbroadcast.html'">Broadcast</button>
    <button id="previewOrganizerBtn" class="toolbar-btn" onclick="location.href='Previewpage.html'">Preview</button>
    <div class="toolbar-spacer"></div>
    <div id="authBtnContainer">
      <button id="logout-btn" class="auth-btn">Log Out</button>
    </div>
  </div>
  <h1 class="view-users-title">Manage Users & Organizations</h1>

  <div class="filter-bar">
    <select id="filterRole">
      <option value="all">All Users</option>
      <option value="student">Students</option>
      <option value="organizer">Organizers</option>
    </select>
    <button id="refreshBtn">Refresh</button>
  </div>

  <table class="view-users-table">
    <thead>
      <tr>
        <th>Full Name</th>
        <th>Email</th>
        <th>Role</th>
        <th>Organization / School</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="usersTable"></tbody>
  </table>

  <script type="module">
  import { auth, db } from "../../js/Shared/firebase-config.js";
  import {
    collection,
    getDocs,
    deleteDoc,
    doc,
    updateDoc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
  import { onAuthStateChanged, getIdTokenResult, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

  const usersTable = document.getElementById("usersTable");
  const filterRole = document.getElementById("filterRole");
  const refreshBtn = document.getElementById("refreshBtn");
  const logoutBtn = document.getElementById("logout-btn");

  // üß© Step 1: Check if the current user is admin
  // üß© Step 1: Check if the current user is admin (using custom claim)
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    console.log("‚ö†Ô∏è No user signed in.");
    alert("Please sign in first.");
    window.location.href = "../Registration/SignIn.html";
    return;
  }

  try {
    // ‚úÖ Get user's token claims
    const tokenResult = await getIdTokenResult(user);
    const isAdmin = tokenResult.claims.admin === true;

    if (isAdmin) {
      console.log(`‚úÖ Admin confirmed via custom claim: ${user.email}`);
      loadUsers(); // proceed to load the table
    } else {
      console.log(`üö´ Not an admin: ${user.email}`);
      alert("Access denied ‚Äî admins only.");
      await signOut(auth);
      window.location.href = "../Registration/SignIn.html";
    }
  } catch (error) {
    console.error("Error checking admin status:", error);
    alert("Error verifying access. Please try again.");
    await signOut(auth);
    window.location.href = "../Registration/SignIn.html";
  }
});

  // üß© Step 2: Function to load users into the table
  async function loadUsers(roleFilter = "all") {
    usersTable.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
    const querySnapshot = await getDocs(collection(db, "users"));
    usersTable.innerHTML = "";

    querySnapshot.forEach((docSnap) => {
      const user = docSnap.data();
      const uid = docSnap.id;

      if (roleFilter !== "all" && user.role !== roleFilter) return;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${user.fullname || "N/A"}</td>
        <td>${user.email}</td>
        <td>${user.role}</td>
        <td>${user.organization || user.school || "-"}</td>
        <td>
          <button class="delete-btn" data-id="${uid}">Delete</button>
          <button class="role-btn" data-id="${uid}">Assign Role</button>
        </td>
      `;
      usersTable.appendChild(row);
    });

    if (usersTable.children.length === 0) {
      usersTable.innerHTML = "<tr><td colspan='5'>No users found.</td></tr>";
    }

    // Delete user
    document.querySelectorAll(".delete-btn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        if (confirm("Are you sure you want to delete this user and their organization?")) {
          await deleteDoc(doc(db, "users", btn.dataset.id));
          alert("User deleted successfully.");
          loadUsers(filterRole.value);
        }
      });
    });

    // Assign role
    document.querySelectorAll(".role-btn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const newRole = prompt("Enter new role (student / organizer / admin):").trim().toLowerCase();
        if (!["student", "organizer", "admin"].includes(newRole)) {
          alert("Invalid role.");
          return;
        }
        await updateDoc(doc(db, "users", btn.dataset.id), { role: newRole });
        alert("Role updated successfully!");
        loadUsers(filterRole.value);
      });
    });
  }

  // Filter and refresh
  filterRole.addEventListener("change", () => loadUsers(filterRole.value));
  refreshBtn.addEventListener("click", () => loadUsers(filterRole.value));

  // Logout button
  if (logoutBtn) {
    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
        window.location.href = "../Registration/SignIn.html";
      } catch (error) {
        console.error("Logout error:", error);
        alert("Error logging out.");
      }
    });
  }
</script>

</body>
</html>
