<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Users & Organizations</title>
  <link rel="icon" type="image/png" href="../../assets/images/evently_logo_DT.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../css/Shared/dashboard.css">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: radial-gradient(circle farthest-corner at 10% 20%, #367bfc 16.3%, #002976 100.2%);
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 2rem;
    }
    h1 {
      color: #fff;
      margin-bottom: 1rem;
    }
    .filter-bar {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 1rem;
    }
    select, button {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-family: 'Montserrat', sans-serif;
    }
    select { background: #f6f6f6; }
    button.delete-btn {
      background: #ff5252;
      color: white;
    }
    button.role-btn {
      background: #5d7bd0;
      color: white;
    }
    table {
      width: 90%;
      max-width: 900px;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 0.8rem 1rem;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #5d7bd0;
      color: white;
    }
  </style>
</head>

<body>
  <h1>Manage Users & Organizations</h1>

  <div class="filter-bar">
    <select id="filterRole">
      <option value="all">All Users</option>
      <option value="student">Students</option>
      <option value="organizer">Organizers</option>
    </select>
    <button id="refreshBtn">Refresh</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Full Name</th>
        <th>Email</th>
        <th>Role</th>
        <th>Organization / School</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="usersTable"></tbody>
  </table>

  <script type="module">
  import { auth, db } from "../../Shared/firebase-config.js";
  import {
    collection,
    getDocs,
    deleteDoc,
    doc,
    updateDoc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
  import { onAuthStateChanged, getIdTokenResult} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

  const usersTable = document.getElementById("usersTable");
  const filterRole = document.getElementById("filterRole");
  const refreshBtn = document.getElementById("refreshBtn");

  // üß© Step 1: Check if the current user is admin
  // üß© Step 1: Check if the current user is admin (using custom claim)
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    console.log("‚ö†Ô∏è No user signed in.");
    alert("Please sign in first.");
    window.location.href = "../Registration/SignIn.html";
    return;
  }

  try {
    // ‚úÖ Get user's token claims
    const tokenResult = await getIdTokenResult(user);
    const isAdmin = tokenResult.claims.admin === true;

    if (isAdmin) {
      console.log(`‚úÖ Admin confirmed via custom claim: ${user.email}`);
      loadUsers(); // proceed to load the table
    } else {
      console.log(`üö´ Not an admin: ${user.email}`);
      alert("Access denied ‚Äî admins only.");
      await signOut(auth);
      window.location.href = "../Registration/SignIn.html";
    }
  } catch (error) {
    console.error("Error checking admin status:", error);
    alert("Error verifying access. Please try again.");
    await signOut(auth);
    window.location.href = "../Registration/SignIn.html";
  }
});

  // üß© Step 2: Function to load users into the table
  async function loadUsers(roleFilter = "all") {
    usersTable.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
    const querySnapshot = await getDocs(collection(db, "users"));
    usersTable.innerHTML = "";

    querySnapshot.forEach((docSnap) => {
      const user = docSnap.data();
      const uid = docSnap.id;

      if (roleFilter !== "all" && user.role !== roleFilter) return;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${user.fullname || "N/A"}</td>
        <td>${user.email}</td>
        <td>${user.role}</td>
        <td>${user.organization || user.school || "-"}</td>
        <td>
          <button class="delete-btn" data-id="${uid}">Delete</button>
          <button class="role-btn" data-id="${uid}">Assign Role</button>
        </td>
      `;
      usersTable.appendChild(row);
    });

    if (usersTable.children.length === 0) {
      usersTable.innerHTML = "<tr><td colspan='5'>No users found.</td></tr>";
    }

    // Delete user
    document.querySelectorAll(".delete-btn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        if (confirm("Are you sure you want to delete this user and their organization?")) {
          await deleteDoc(doc(db, "users", btn.dataset.id));
          alert("User deleted successfully.");
          loadUsers(filterRole.value);
        }
      });
    });

    // Assign role
    document.querySelectorAll(".role-btn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const newRole = prompt("Enter new role (student / organizer / admin):").trim().toLowerCase();
        if (!["student", "organizer", "admin"].includes(newRole)) {
          alert("Invalid role.");
          return;
        }
        await updateDoc(doc(db, "users", btn.dataset.id), { role: newRole });
        alert("Role updated successfully!");
        loadUsers(filterRole.value);
      });
    });
  }

  // Filter and refresh
  filterRole.addEventListener("change", () => loadUsers(filterRole.value));
  refreshBtn.addEventListener("click", () => loadUsers(filterRole.value));
</script>

</body>
</html>
