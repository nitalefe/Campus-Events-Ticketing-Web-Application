<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Users & Organizations</title>
  <link rel="icon" type="image/png" href="../../assets/images/evently_logo_DT.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../css/Shared/dashboard.css">
  <link rel="stylesheet" href="../../css/Shared/toolbar.css">
  <link rel="stylesheet" href="../../css/Administrator/view-users.css">
</head>

<body class="view-users-page">
  <!-- Shared toolbar (copied from admin-dashboard) -->
  <div class="toolbar">
    <img src="../../assets/images/evently_logo_DT.png" alt="Evently Logo" class="toolbar-logo" onclick="location.href='admin-dashboard.html'">

  <button class="toolbar-btn" onclick="location.href='admin-dashboard.html'">Home</button>
    <button class="toolbar-btn" onclick="location.href='../'">See Organizers</button>
    <button id="previewOrganizerBtn" class="toolbar-btn" onclick="location.href='Previewpage.html'">Preview</button>
    <div class="toolbar-spacer"></div>
    <button class="toolbar-btn" onclick="location.href='../Registration/website.html'">Profile</button>
    <div id="authBtnContainer">
      <button id="logout-btn" class="auth-btn">Log Out</button>
    </div>
  </div>
  <h1 class="view-users-title">Manage Users & Organizations</h1>

  <div class="filter-bar">
    <input id="searchInput" type="search" placeholder="Search name or email" style="margin-right:8px;padding:6px;border-radius:6px;border:1px solid #ddd">
    <select id="filterRole">
      <option value="all">All Users</option>
      <option value="student">Students</option>
      <option value="organizer">Organizers</option>
    </select>
    <button id="refreshBtn">Refresh</button>
  </div>

  <table class="view-users-table">
    <thead>
      <tr>
        <th>Full Name</th>
        <th>Email</th>
        <th>Role</th>
        <th>Organization / School</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="usersTable"></tbody>
  </table>

  <script type="module">
  import { auth, db } from "../../js/Shared/firebase-config.js";
  import {
    collection,
    getDocs,
    deleteDoc,
    doc,
    updateDoc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
  import { onAuthStateChanged, getIdTokenResult} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

  const usersTable = document.getElementById("usersTable");
  const filterRole = document.getElementById("filterRole");
  const refreshBtn = document.getElementById("refreshBtn");
  const searchInput = document.getElementById("searchInput");

  // in-memory cache of users for client-side searching/filtering
  let allUsers = [];

  // üß© Step 1: Check if the current user is admin
  // üß© Step 1: Check if the current user is admin (using custom claim)
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    console.log("‚ö†Ô∏è No user signed in.");
    alert("Please sign in first.");
    window.location.href = "../Registration/SignIn.html";
    return;
  }

  try {
    // ‚úÖ Get user's token claims
    const tokenResult = await getIdTokenResult(user);
    const isAdmin = tokenResult.claims.admin === true;

    if (isAdmin) {
      console.log(`‚úÖ Admin confirmed via custom claim: ${user.email}`);
      loadUsers(); // proceed to load the table
    } else {
      console.log(`üö´ Not an admin: ${user.email}`);
      alert("Access denied ‚Äî admins only.");
      await signOut(auth);
      window.location.href = "../Registration/SignIn.html";
    }
  } catch (error) {
    console.error("Error checking admin status:", error);
    alert("Error verifying access. Please try again.");
    await signOut(auth);
    window.location.href = "../Registration/SignIn.html";
  }
});

  // üß© Step 2: Function to load users into the table
  // Load users once and store them in `allUsers`. Rendering is handled by renderUsers
  async function loadUsers(roleFilter = "all") {
    usersTable.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
    const querySnapshot = await getDocs(collection(db, "users"));
    usersTable.innerHTML = "";

    allUsers = []; // reset
    querySnapshot.forEach((docSnap) => {
      allUsers.push({ uid: docSnap.id, data: docSnap.data() });
    });

    renderUsers(allUsers, roleFilter, searchInput ? searchInput.value : "");
  }

  // Render users into the table using filters and search term
  function renderUsers(users, roleFilter = "all", searchTerm = "") {
    usersTable.innerHTML = "";
    const term = (searchTerm || "").toLowerCase().trim();

    const filtered = users.filter(u => {
      const user = u.data || {};
      if (roleFilter !== "all" && user.role !== roleFilter) return false;
      if (!term) return true;
      const name = (user.fullname || "").toLowerCase();
      const email = (user.email || "").toLowerCase();
      return name.includes(term) || email.includes(term);
    });

    if (filtered.length === 0) {
      usersTable.innerHTML = "<tr><td colspan='5'>No users found.</td></tr>";
      return;
    }

    filtered.forEach((u) => {
      const user = u.data;
      const uid = u.uid;
      const row = document.createElement("tr");
      // Name links to public profile. Private profiles will show a locked message on the profile page.
      const profileHref = `../Profile/public-profile.html?id=${uid}`;
      const privateBadge = (user.publicProfile === false) ? ' <span class="private-badge" title="Private account">üîí</span>' : '';
      row.innerHTML = `
        <td><a class="user-link" href="${profileHref}">${user.fullname || "N/A"}</a>${privateBadge}</td>
        <td>${user.email}</td>
        <td>${user.role}</td>
        <td>${user.organization || user.school || "-"}</td>
        <td>
          <button class="delete-btn" data-id="${uid}">Delete</button>
          <button class="role-btn" data-id="${uid}">Assign Role</button>
        </td>
      `;
      usersTable.appendChild(row);
    });

    // Wire up actions on the rendered rows
    usersTable.querySelectorAll(".delete-btn").forEach((btn) => {
      btn.addEventListener("click", async (ev) => {
        ev.preventDefault();
        if (confirm("Are you sure you want to delete this user and their organization?")) {
          await deleteDoc(doc(db, "users", btn.dataset.id));
          alert("User deleted successfully.");
          // reload users to refresh cache
          await loadUsers(filterRole.value);
        }
      });
    });

    usersTable.querySelectorAll(".role-btn").forEach((btn) => {
      btn.addEventListener("click", async (ev) => {
        ev.preventDefault();
        const newRole = prompt("Enter new role (student / organizer / admin):");
        if (!newRole) return;
        const nr = newRole.trim().toLowerCase();
        if (!["student", "organizer", "admin"].includes(nr)) {
          alert("Invalid role.");
          return;
        }
        await updateDoc(doc(db, "users", btn.dataset.id), { role: nr });
        alert("Role updated successfully!");
        await loadUsers(filterRole.value);
      });
    });
  }

  // Filter and refresh
  filterRole.addEventListener("change", () => loadUsers(filterRole.value));
  refreshBtn.addEventListener("click", () => loadUsers(filterRole.value));
</script>

</body>
</html>
