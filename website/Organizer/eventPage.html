<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Event Details</title>
  <link rel="icon" type="image/png" href="../../assets/images/evently_logo_DT.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../css/Organizer/eventPage.css">
  <link rel="stylesheet" href="../../css/Shared/toolbar.css">
</head>

<body>

  <div class="toolbar">
    <img src="../../assets/images/evently_logo_DT.png" alt="Evently Logo" class="toolbar-logo"
      onclick="location.href='organizer-dashboard.html'">
    <button class="toolbar-btn" onclick="location.href='organizer-dashboard.html'">Home</button>
    <button class="toolbar-btn" onclick="location.href='eventCreation.html'">Create New Event</button>
    <button class="toolbar-btn" onclick="location.href='myEvents.html'">My Events</button>
    <button class="toolbar-btn" onclick="location.href='broadcast.html'">Broadcast</button>
    <button class="toolbar-btn" onclick="location.href='../Shared_Pages/inbox.html'">Inbox</button>
    <button class="toolbar-btn" onclick="location.href='../Profile/following.html'">Following</button>
    <div class="toolbar-spacer"></div>
    <button class="toolbar-btn" onclick="location.href='../Profile/profile.html'">Profile</button>
    <div id="authBtnContainer">
      <button id="logout-btn" class="auth-btn">Log Out</button>
    </div>
  </div>

  <div class="container">
    <img id="eventBanner" src="https://via.placeholder.com/900x340" class="event-image" alt="Event Banner">
    <h1 class="event-title">Loading...</h1>
    <div class="event-date-location"></div>
    <div class="event-description">Loading event details...</div>
    <button id="editBtn" class="buy-ticket-btn"
      onclick="location.href='eventEdit.html?id=' + new URLSearchParams(window.location.search).get('id')">
      Edit Event
    </button>
    <button id="scanBtn" class="buy-ticket-btn" onclick="location.href='qrScanner.html?id=' + new URLSearchParams(window.location.search).get('id')">Scan Ticket</button>

    <button id="analyticsBtn" class="buy-ticket-btn" onclick="location.href='EventDashboard.html?id=' + new URLSearchParams(window.location.search).get('id')">View Analytics</button>

    <button id="attendeesBtn" class="buy-ticket-btn" onclick="location.href='Attendee.html?id=' + new URLSearchParams(window.location.search).get('id')">Attendees</button>

    <!-- Firebase + Auth -->
    <script type="module" src="../../js/Registration/auth.js"></script>

    <!--LOADING EVENTS INTO THE EVENT PAGE -->
    <script type="module">
      import { auth, db } from "../../js/Shared/firebase-config.js";
      import { doc, getDoc, updateDoc, setDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

      const params = new URLSearchParams(window.location.search);
      const eventId = params.get("id");

      const titleEl = document.querySelector(".event-title");
      const descEl = document.querySelector(".event-description");
      const dateLocEl = document.querySelector(".event-date-location");
      const bannerEl = document.getElementById("eventBanner");
      const editBtn = document.getElementById('editBtn');
      const scanBtn = document.getElementById('scanBtn');
      const analyticsBtn = document.getElementById('analyticsBtn');
      const attendeesBtn = document.getElementById('attendeesBtn');

      // ----------------------------
      // 3Ô∏è‚É£ Load event details
      // ----------------------------
      async function loadEventDetails(user) {
        if (!eventId) {
          titleEl.textContent = "Event not found.";
          return;
        }

        const docRef = doc(db, "events", eventId);
        const snap = await getDoc(docRef);

        if (!snap.exists()) {
          titleEl.textContent = "Event not found.";
          descEl.textContent = "";
          return;
        }

        const data = snap.data();
        titleEl.textContent = data.eventName || "Untitled Event";
        descEl.innerHTML = data.eventDescription || "No description available.";

        const dateObj = data.eventDateTime?.toDate?.();
        const dateStr = dateObj ? dateObj.toDateString() : "Unknown date";
        dateLocEl.innerHTML = `
      <span>${dateStr}</span><br>
      <span>${data.eventLocation || "Unknown location"}</span>
    `;

        // Load event banner from Firebase
        if (data.banner) {
          bannerEl.src = data.banner;
          bannerEl.alt = `${data.eventName} Banner`;
        } else {
          // Fallback to placeholder if no banner is set
          bannerEl.src = "https://via.placeholder.com/900x340";
          bannerEl.alt = "Event Banner";
        }

        // üö´ Hide organizer-only buttons if not owner
        if (!user || user.uid !== data.createdBy) {
          editBtn.style.display = "none";
          scanBtn.style.display = "none";
          analyticsBtn.style.display = "none";
          if (attendeesBtn) attendeesBtn.style.display = "none";
        } else {
          // ‚úÖ Organizer can edit, scan, view analytics, view attendees
          editBtn.onclick = () => location.href = `eventEdit.html?id=${eventId}`;
          scanBtn.onclick = () => location.href = `qrScanner.html?id=${eventId}`;
          analyticsBtn.onclick = () => location.href = `EventDashboard.html?id=${eventId}`;
          if (attendeesBtn) attendeesBtn.onclick = () => location.href = `Attendee.html?id=${eventId}`;
        }
      }

      // ----------------------------
      // üîπ Auth State Listener
      // ----------------------------
      onAuthStateChanged(auth, async (user) => {
        console.log("[eventPage] Auth user:", user?.uid || "No user");
        await loadEventDetails(user);
      });
    </script>
</body>

</html>